{{- $context := .Context -}}
{{- $params := .Params -}}

<section class="widget donation">
    <div class="widget-icon">
        {{ partial "helper/icon" "currency-ethereum" }}
    </div>
    <h2 class="widget-title section-title">
        {{ $context.Site.Params.donation.title }}
    </h2>
    <div class="stack-widget-donation-card">
        <div class="stack-widget-donation-section">
            {{- range $context.Site.Params.donation.cryptos }}
            <div class="stack-widget-donation-item" data-crypto="{{ .label | lower }}">
                <div class="stack-widget-donation-item-bg">
                    {{ partial "helper/icon" (.icon | default "wallet") }}
                </div>
                <span class="stack-widget-donation-label">{{ .label }}</span>
                <div class="stack-widget-donation-address">
                    <code>{{ .address }}</code>
                </div>
                <button class="stack-widget-donation-btn-copy" data-clipboard-text="{{ .address }}" title="Copy">
                    Copy
                </button>
                <input type="number" class="stack-widget-donation-amount-input" value="{{ .amount | default 1 }}"
                    step="0.001" min="0" style="display: none;">
                {{- if and (isset . "donate") .donate }}
                <button class="stack-widget-donate-btn-donate" title="Donate" onclick="toggleDonateMode(this)"
                    data-address="{{ .address }}">
                    Donate
                </button>
                {{- end }}
            </div>
            {{- end }}
        </div>
        {{ if $context.Site.Params.donation.qrcode }}
        <div class="stack-widget-donation-card">
            {{ if $context.Site.Params.donation.link }}
            <a href="{{ $context.Site.Params.donation.link }}"
                target="{{ $context.Site.Params.donation.target | default " _self" }}" rel="noopener noreferrer">
                <img src="{{ $context.Site.Params.donation.qrcode }}" alt="donation" class="stack-widget-donation-qr">
            </a>
            {{ else }}
            <img src="{{ $context.Site.Params.donation.qrcode }}" alt="donation" class="stack-widget-donation-qr">
            {{ end }}
        </div>
        {{ end }}
    </div>
</section>

<!-- 简单的 Toast 组件 -->
<div id="stack-widget-donation-toast" class="stack-widget-donation-toast"></div>

<script>
    // Toast 管理函数
    function showToast(message, type = 'info', duration = 3000) {
        const toast = document.getElementById('stack-widget-donation-toast');
        
        // 设置消息和类型
        toast.textContent = message;
        toast.className = `stack-widget-donation-toast stack-widget-donation-toast-${type} stack-widget-donation-toast-show`;
        
        // 自动隐藏
        setTimeout(() => {
            toast.className = 'stack-widget-donation-toast';
        }, duration);
    }

    async function toggleDonateMode(donateBtn) {
        const donationItem = donateBtn.closest('.stack-widget-donation-item');
        const amountInput = donationItem.querySelector('.stack-widget-donation-amount-input');
        const address = donateBtn.getAttribute('data-address');
        const label = donationItem.querySelector('.stack-widget-donation-label').textContent.trim();

        // 去除文本内容的空格，确保比较准确
        const buttonText = donateBtn.textContent.trim();

        if (buttonText === 'Donate') {
            // 第一次点击：显示输入框，按钮变为 Pay
            donateBtn.classList.add('active');
            donateBtn.textContent = 'Pay';
            amountInput.style.display = 'block';
            amountInput.focus();
        } else if (buttonText === 'Pay') {
            // 第二次点击：唤起钱包支付
            const amount = amountInput.value;
            if (!amount || amount <= 0) {
                showToast('请输入有效的捐赠金额', 'warning');
                return;
            }
            // 转换为数值类型
            const amountNum = parseFloat(amount);
            // 支付过程中禁用按钮，防止重复点击
            donateBtn.disabled = true;
            donateBtn.textContent = 'Paying';

            try {
                await payWithWallet(address, amountNum, label);
                // 支付成功后重置状态
                resetDonateButton(donateBtn, amountInput);
            } catch (error) {
                console.error('支付失败:', error);
                showToast('支付失败: ' + error.message, 'error');
                // 支付失败后恢复 Pay 状态
                donateBtn.textContent = 'Pay';
            } finally {
                // 无论成功失败都重新启用按钮
                donateBtn.disabled = false;
            }
        } else {
            // 取消状态：恢复初始状态
            resetDonateButton(donateBtn, amountInput);
        }
    }

    function resetDonateButton(donateBtn, amountInput) {
        donateBtn.classList.remove('active');
        donateBtn.textContent = 'Donate';
        donateBtn.disabled = false;
        amountInput.style.display = 'none';
        // 获取配置的默认金额，确保为数值类型
        const donationItem = donateBtn.closest('.stack-widget-donation-item');
        const defaultAmountStr = donationItem.querySelector('.stack-widget-donation-amount-input').getAttribute('value');
        const defaultAmount = parseFloat(defaultAmountStr);
        amountInput.value = defaultAmount;
    }

    // 获取代币配置
    function getTokenConfig(label) {
        const tokenConfigs = {
            'ETH': {
                symbol: 'ETH',
                decimals: 18,
                contractAddress: null,
                chainId: '0x1',
                network: 'ethereum'
            }
        };

        // 尝试匹配标签中的代币符号
        for (const [key, config] of Object.entries(tokenConfigs)) {
            if (label.toUpperCase().includes(key)) {
                return config;
            }
        }

        // 默认返回 ETH 配置
        return tokenConfigs.ETH;
    }

    async function payWithWallet(toAddress, amount, label) {
        const tokenConfig = getTokenConfig(label);

        // 检查是否支持该代币
        if (tokenConfig.error) {
            showToast(tokenConfig.error, 'error');
            throw new Error(tokenConfig.error);
        }

        // 只支持以太坊网络
        return await payWithEthereum(toAddress, amount, tokenConfig);
    }

    async function payWithEthereum(toAddress, amount, tokenConfig) {
        // 检查是否安装了以太坊钱包
        if (typeof window.ethereum === 'undefined') {
            showToast('请先安装支持以太坊的浏览器钱包（如 MetaMask、Trust Wallet、Coinbase Wallet 等）', 'warning', 4000);
            throw new Error('请先安装支持以太坊的浏览器钱包（如 MetaMask、Trust Wallet、Coinbase Wallet 等）');
        }

        try {
            // 请求连接钱包
            await window.ethereum.request({ method: 'eth_requestAccounts' });

            // 检查网络
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            if (chainId !== tokenConfig.chainId) {
                try {
                    // 尝试自动切换到正确的网络
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: tokenConfig.chainId }],
                    });
                    showToast('已切换到以太坊主网', 'success');
                } catch (switchError) {
                    // 如果切换失败，提供更详细的错误信息
                    if (switchError.code === 4902) {
                        showToast('请在钱包中手动添加以太坊主网', 'warning', 4000);
                        throw new Error('请在钱包中手动添加以太坊主网');
                    } else if (switchError.code === 4001) {
                        showToast('用户拒绝切换网络', 'info');
                        throw new Error('用户拒绝切换网络');
                    } else {
                        showToast(`网络切换失败，请手动切换到以太坊主网 (Chain ID: ${tokenConfig.chainId})`, 'warning', 4000);
                        throw new Error(`网络切换失败，请手动切换到以太坊主网 (Chain ID: ${tokenConfig.chainId})`);
                    }
                }
            }

            // 获取当前账户
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length === 0) {
                showToast('请先连接钱包账户', 'warning');
                throw new Error('请先连接钱包账户');
            }

            const fromAddress = accounts[0];

            let txHash;

            if (tokenConfig.contractAddress) {
                // ERC-20 代币转账
                txHash = await sendERC20Token(fromAddress, toAddress, amount, tokenConfig);
            } else {
                // ETH 原生代币转账
                txHash = await sendETH(fromAddress, toAddress, amount, tokenConfig);
            }

            showToast(`支付成功！交易哈希: ${txHash.slice(0, 10)}...`, 'success', 5000);

            // 隐藏金额输入框
            const amountInput = document.querySelector('.donation-amount-input');
            if (amountInput) {
                amountInput.style.display = 'none';
            }

            return txHash;

        } catch (error) {
            if (error.code === 4001) {
                showToast('用户取消了交易', 'info');
                throw new Error('用户取消了交易');
            } else {
                throw error;
            }
        }
    }

    async function sendETH(fromAddress, toAddress, amount, tokenConfig) {
        // 将 ETH 金额转换为 Wei
        const amountInWei = '0x' + (parseFloat(amount) * Math.pow(10, tokenConfig.decimals)).toString(16);

        const transactionParameters = {
            to: toAddress,
            from: fromAddress,
            value: amountInWei,
            gas: '0x5208', // 21000 gas (标准转账)
        };

        return await window.ethereum.request({
            method: 'eth_sendTransaction',
            params: [transactionParameters],
        });
    }

    async function sendERC20Token(fromAddress, toAddress, amount, tokenConfig) {
        // ERC-20 转账需要调用合约的 transfer 方法
        const amountInUnits = (parseFloat(amount) * Math.pow(10, tokenConfig.decimals)).toString(16);

        // ERC-20 transfer 方法的 ABI 编码
        // transfer(address,uint256)
        const methodId = '0xa9059cbb'; // transfer 方法的签名
        const paddedAddress = toAddress.slice(2).padStart(64, '0');
        const paddedAmount = amountInUnits.padStart(64, '0');
        const data = methodId + paddedAddress + paddedAmount;

        const transactionParameters = {
            to: tokenConfig.contractAddress,
            from: fromAddress,
            data: data,
            gas: '0x186A0', // 100000 gas (ERC-20 转账)
        };

        return await window.ethereum.request({
            method: 'eth_sendTransaction',
            params: [transactionParameters],
        });
    }
</script>

<!-- 捐赠卡片复制按钮 -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const copyButtons = document.querySelectorAll('.stack-widget-donation-btn-copy');

        copyButtons.forEach(function (button) {
            button.addEventListener('click', function () {
                const text = this.getAttribute('data-clipboard-text');
                const originalText = this.textContent;
                navigator.clipboard.writeText(text).then(function () {
                    button.textContent = 'Copied!';
                    showToast('地址已复制到剪贴板', 'success');
                    setTimeout(function () {
                        button.textContent = originalText;
                    }, 1500);
                }).catch(function () {
                    button.textContent = 'Failed!';
                    showToast('复制失败', 'error');
                    setTimeout(function () {
                        button.textContent = originalText;
                    }, 1500);
                });
            });
        });
    });
</script>