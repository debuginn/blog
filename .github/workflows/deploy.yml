name: Deploy Blog (Event Driven)

on:
  push:
    branches:
      - main
  workflow_dispatch:
  repository_dispatch:
    types:
      - content-updated

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1 Checkout 主仓库 + submodule（只读）
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      # 2 拉取 submodule 最新内容（不写回 main）
      - name: Update content submodule
        run: |
          git submodule update --remote --recursive

      # 3 判断 content 是否真的发生变化
      - name: Detect content change
        id: content
        run: |
          if git diff --quiet HEAD -- content; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      # 4 统一判断是否需要部署
      - name: Decide deploy
        id: deploy
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
          elif [[ "${{ steps.content.outputs.changed }}" == "true" ]]; then
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_deploy=false" >> "$GITHUB_OUTPUT"
          fi

      # 5 无需部署时提示并结束
      - name: Skip deploy when not required
        if: steps.deploy.outputs.should_deploy == 'false'
        run: |
          echo "No deploy required. Exit workflow."

      # 6 Setup Go（Hugo 模块依赖）
      - name: Setup Go
        if: steps.deploy.outputs.should_deploy == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: "^1.17"

      # 7 Setup Hugo
      - name: Setup Hugo
        if: steps.deploy.outputs.should_deploy == 'true'
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: latest
          extended: true

      # 8 Hugo 资源缓存（只用于加速）
      - name: Cache Hugo resources
        if: steps.deploy.outputs.should_deploy == 'true'
        uses: actions/cache@v4
        with:
          path: resources
          key: hugo-resources-${{ hashFiles('config/**', 'themes/**', 'go.sum') }}

      # 9 Build
      - name: Build site
        if: steps.deploy.outputs.should_deploy == 'true'
        run: |
          hugo --minify --gc

      # 10 Deploy 到 gh-pages
      - name: Deploy to GitHub Pages
        if: steps.deploy.outputs.should_deploy == 'true'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: public
          clean: true
          single-commit: true

      # 11 等待 Pages 生效
      - name: Wait for GitHub Pages to be ready
        if: steps.deploy.outputs.should_deploy == 'true'
        run: sleep 60

      # 12 提交 IndexNow
      - name: Submit IndexNow
        if: steps.deploy.outputs.should_deploy == 'true'
        uses: bojieyang/indexnow-action@v2
        with:
          sitemap-location: https://blog.debuginn.com/sitemap.xml
          key: ${{ secrets.INDEXNOW_KEY }}
          since: 7
          since-unit: day
          key-location: https://blog.debuginn.com/${{ secrets.INDEXNOW_KEY }}.txt
